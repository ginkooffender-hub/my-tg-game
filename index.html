const tg = window.Telegram.WebApp;
        tg.expand();

        // Начальные настройки баланса
        let state = JSON.parse(localStorage.getItem('mTree_v2')) || {
            coins: 0, 
            power: 1, 
            energy: 100, 
            maxEnergy: 100, 
            passive: 0, 
            regenLevel: 1, // Уровень регенерации
            lastTime: Date.now()
        };

        function update() {
            document.getElementById('coins').textContent = Math.floor(state.coins);
            document.getElementById('pIncome').textContent = state.passive;
            document.getElementById('eText').textContent = Math.floor(state.energy) + "/" + state.maxEnergy;
            document.getElementById('eFill').style.width = (state.energy / state.maxEnergy * 100) + "%";
            
            // Цены на бусты (растут экспоненциально)
            document.getElementById('tapCost').textContent = 100 * Math.pow(2, state.power - 1);
            document.getElementById('energyCost').textContent = 50 * (state.maxEnergy / 50);
            document.getElementById('autoCost').textContent = (state.passive + 1) * 500;

            state.lastTime = Date.now();
            localStorage.setItem('mTree_v2', JSON.stringify(state));
        }

        // Клик по дереву
        document.getElementById('tree').onclick = (e) => {
            if (state.energy < 1) {
                tg.HapticFeedback.notificationOccurred('warning');
                return;
            }
            
            state.coins += state.power;
            state.energy -= 1; // 1 тап = 1 энергия
            
            tg.HapticFeedback.impactOccurred('light');
            update();
        };

        // Покупка бустов
        function buy(type) {
            if (type === 'tap') {
                let cost = 100 * Math.pow(2, state.power - 1);
                if (state.coins >= cost) {
                    state.coins -= cost; state.power++;
                }
            } else if (type === 'energy') {
                let cost = 50 * (state.maxEnergy / 50);
                if (state.coins >= cost) {
                    state.coins -= cost; state.maxEnergy += 50;
                }
            } else if (type === 'auto') {
                let cost = (state.passive + 1) * 500;
                if (state.coins >= cost) {
                    state.coins -= cost; state.passive += 0.5; // Пассивный доход прибавляется по чуть-чуть
                }
            }
            tg.HapticFeedback.notificationOccurred('success');
            update();
        }

        // ИГРОВОЙ ЦИКЛ (Тики)
        setInterval(() => {
            // Регенерация энергии: 0.2 единицы в 100мс = 2 единицы в секунду.
            // Это значит 100 энергии восстановится за 50 секунд.
            if (state.energy < state.maxEnergy) {
                state.energy = Math.min(state.maxEnergy, state.energy + 0.2); 
            }
            
            // Пассивный доход
            if (state.passive > 0) {
                state.coins += state.passive / 10;
            }
            
            update();
        }, 100);

        // Переключение вкладок
        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        update();
